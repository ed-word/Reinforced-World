<!DOCTYPE html>
<html>
{% load static %}
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Google Maps JavaScript API v3 Example: Directions Complex</title>
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0px;
            font-family: Helvetica, Arial;
        }
    </style>


<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&key=AIzaSyDMaDXP8Btz3RCS1JNAJc9wRNDJb_kEW_Y"></script>
<script src="{% static 'js/v3_epoly.js' %}"></script>
    <script type="text/javascript">
        var map;
        var directionDisplay;
        var directionsService;
        var stepDisplay;

        var position;
        var marker = [];
        var polyline = [];
        var poly2 = [];
        var poly = null;
        var startLocation = [];
        var endLocation = [];
        var timerHandle = [];
        var currentDistance = [];


        var speed = 0.000005,
            wait = 1;
        var infowindow = null;

        var myPano;
        var panoClient;
        var nextPanoId;

        var startLoc = new Array();
        startLoc[0] = 'rio claro, trinidad';
        startLoc[1] = 'preysal, trinidad';
        startLoc[2] = 'san fernando, trinidad';
        startLoc[3] = 'couva, trinidad';

        var endLoc = new Array();
        endLoc[0] = 'princes town, trinidad';
        endLoc[1] = 'tabaquite, trinidad';
        endLoc[2] = 'mayaro, trinidad';
        endLoc[3] = 'arima, trinidad';


        var Colors = ["#FF0000", "#00FF00", "#0000FF"];


        function initialize() {

            infowindow = new google.maps.InfoWindow({
                size: new google.maps.Size(150, 50)
            });

            var myOptions = {
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

            address = 'Trinidad and Tobago'
            geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                'address': address
            }, function (results, status) {
                map.fitBounds(results[0].geometry.viewport);

            });
            // setRoutes();
        }


        function createMarker(latlng, label, html, icon) {
            // alert("createMarker("+latlng+","+label+","+html+","+color+")");
            var contentString = '<b>' + label + '</b><br>' + html;
            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: label,
                icon: icon,
                zIndex: Math.round(latlng.lat() * -100000) << 5
            });
            marker.myname = label;


            google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent(contentString);
                infowindow.open(map, marker);
            });
            return marker;
        }

        function setRoutes() {

            var directionsDisplay = new Array();

            for (var i = 0; i < startLoc.length; i++) {

                var rendererOptions = {
                    map: map,
                    suppressMarkers: true,
                    preserveViewport: true
                }
                directionsService = new google.maps.DirectionsService();

                var travelMode = google.maps.DirectionsTravelMode.DRIVING;

                var request = {
                    origin: startLoc[i],
                    destination: endLoc[i],
                    travelMode: travelMode
                };

                directionsService.route(request, makeRouteCallback(i, directionsDisplay[i]));

            }


            function makeRouteCallback(routeNum, disp) {
                if (polyline[routeNum] && (polyline[routeNum].getMap() != null)) {
                    startAnimation(routeNum);
                    return;
                }
                return function (response, status) {

                    if (status == google.maps.DirectionsStatus.OK) {

                        var bounds = new google.maps.LatLngBounds();
                        var route = response.routes[0];
                        startLocation[routeNum] = new Object();
                        endLocation[routeNum] = new Object();


                        polyline[routeNum] = new google.maps.Polyline({
                            path: [],
                            strokeColor: '#FFFF00',
                            strokeWeight: 3
                        });

                        poly2[routeNum] = new google.maps.Polyline({
                            path: [],
                            strokeColor: '#FFFF00',
                            strokeWeight: 3
                        });


                        // For each route, display summary information.
                        var path = response.routes[0].overview_path;
                        var legs = response.routes[0].legs;


                        disp = new google.maps.DirectionsRenderer(rendererOptions);
                        disp.setMap(map);
                        disp.setDirections(response);


                        //Markers               
                        for (i = 0; i < legs.length; i++) {
                            if (i == 0) {
                                startLocation[routeNum].latlng = legs[i].start_location;
                                startLocation[routeNum].address = legs[i].start_address;
                                // marker = google.maps.Marker({map:map,position: startLocation.latlng});
                                marker[routeNum] = createMarker(legs[i].start_location, "start " + routeNum, legs[i]
 .start_address, "{% static 'images/truck1.png' %}");
                            }
                            endLocation[routeNum].latlng = legs[i].end_location;
                            endLocation[routeNum].address = legs[i].end_address;
                            var steps = legs[i].steps;

                            for (j = 0; j < steps.length; j++) {
                                var nextSegment = steps[j].path;
                                var nextSegment = steps[j].path;

                                for (k = 0; k < nextSegment.length; k++) {
                                    polyline[routeNum].getPath().push(nextSegment[k]);
                                    //bounds.extend(nextSegment[k]);
                                }

                            }
                        }

                    }

                    polyline[routeNum].setMap(map);
                    //map.fitBounds(bounds);
                    startAnimation(routeNum);

                } // else alert("Directions request failed: "+status);

            }

        }

        var lastVertex = 1;
        var stepnum = 0;
        var step = 500; // 5; // metres
        var tick = 100; // milliseconds
        var eol = [];
        //----------------------------------------------------------------------                
        function updatePoly(i, d) {
            // Spawn a new polyline every 20 vertices, because updating a 100-vertex poly is too slow
            if (poly2[i].getPath().getLength() > 20) {
                poly2[i] = new google.maps.Polyline([polyline[i].getPath().getAt(lastVertex - 1)]);
                // map.addOverlay(poly2)
            }

            if (polyline[i].GetIndexAtDistance(d) < lastVertex + 2) {
                if (poly2[i].getPath().getLength() > 1) {
                    poly2[i].getPath().removeAt(poly2[i].getPath().getLength() - 1)
                }
                poly2[i].getPath().insertAt(poly2[i].getPath().getLength(), polyline[i].GetPointAtDistance(d));
            } else {
                poly2[i].getPath().insertAt(poly2[i].getPath().getLength(), endLocation[i].latlng);
            }
        }
        //----------------------------------------------------------------------------

        function animate(index, d) {
            if (d > eol[index]) {

                marker[index].setPosition(endLocation[index].latlng);
                marker[index].setOptions({
                    zIndex: Math.round(latlng.lat() * -100000) << 5
                });
                return;
            }
            var p = polyline[index].GetPointAtDistance(d);

            //map.panTo(p);
            marker[index].setPosition(p);
            marker[index].setOptions({
                zIndex: Math.round(p.lat() * -100000) << 5
            });
            updatePoly(index, d);
            timerHandle[index] = setTimeout("animate(" + index + "," + (d + step) + ")", tick);
            currentDistance[index] = d + step;
        }

        //-------------------------------------------------------------------------

        function startAnimation(index) {
            if (timerHandle[index]) clearTimeout(timerHandle[index]);
            eol[index] = polyline[index].Distance();
            map.setCenter(polyline[index].getPath().getAt(0));

            poly2[index] = new google.maps.Polyline({
                path: [polyline[index].getPath().getAt(0)],
                strokeColor: "#FFFF00",
                strokeWeight: 3
            });

            timerHandle[index] = setTimeout("animate(" + index + ",50)", 2000); // Allow time for the initial map display
            currentDistance[index] = 50;
        }

        //----------------------------------------------------------------------------    
        function stopAnimation(index) {
            clearTimeout(timerHandle[index]);
        }

        function continueAnimation(index) {
            d = currentDistance[index];
            timerHandle[index] = setTimeout("animate(" + index + "," + d + ")", tick);
        }
    </script>
</head>

<body onload="initialize()">

    <div id="tools">

        <button onclick="setRoutes();">Start</button>
        <button onclick="stopAnimation(0);">Pause(0)</button>
        <button onclick="stopAnimation(1);">Pause(1)</button>
        <button onclick="stopAnimation(2);">Pause(2)</button>
        <button onclick="stopAnimation(3);">Pause(3)</button>
        <button onclick="continueAnimation(0);">Continue(0)</button>
        <button onclick="continueAnimation(1);">Continue(1)</button>
        <button onclick="continueAnimation(2);">Continue(2)</button>
        <button onclick="continueAnimation(3);">Continue(3)</button>
    </div>

    <div id="map_canvas" style="width:100%;height:100%;"></div>
    </script>
    
</body>

</html>
